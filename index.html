<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyGlot Coach V3 - Split View (Có Level)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col">

    <div id="root" class="flex-1 flex flex-col h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconBook = () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const IconCheck = () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconRefresh = () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;
        const IconSpeaker = () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        const IconKey = () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>;
        const IconArrowRight = () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [showKeyInput, setShowKeyInput] = useState(!apiKey);
            
            const [scope, setScope] = useState('word'); 
            const [difficulty, setDifficulty] = useState('medium'); // easy, medium, hard
            const [mode, setMode] = useState(1); 
            
            const [inputData, setInputData] = useState('');
            const [step, setStep] = useState('input');
            const [challenges, setChallenges] = useState(null); 
            const [userAnswers, setUserAnswers] = useState({});
            const [feedback, setFeedback] = useState(null);
            
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const rightColumnRef = useRef(null);

            const saveApiKey = (rawKey) => {
                const key = rawKey.trim();
                if (!key.startsWith('AIza')) {
                    setError('Key không hợp lệ (Phải bắt đầu bằng AIza)');
                    return;
                }
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                setShowKeyInput(false);
                setError('');
            };

            const speakText = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            };

            const parseJSON = (text) => {
                try {
                    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleanText);
                } catch (e) {
                    console.error("JSON Parse Error:", text);
                    throw new Error("AI trả về định dạng lỗi. Vui lòng thử lại.");
                }
            };

            const callGemini = async (prompt, sysInstruct) => {
                if (!apiKey) throw new Error("Thiếu API Key");
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: sysInstruct }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!resp.ok) throw new Error("Lỗi kết nối API hoặc hết lượt.");
                const data = await resp.json();
                return parseJSON(data.candidates?.[0]?.content?.parts?.[0]?.text);
            };

            const handleGenerate = async () => {
                if (!inputData.trim()) return;
                setLoading(true); setError(''); setFeedback(null); setUserAnswers({});
                
                try {
                    let prompt = "";
                    let sys = "Bạn là trợ lý ngôn ngữ. Trả về JSON thuần túy.";
                    const words = inputData.split(/[\n,;]+/).map(w => w.trim()).filter(w => w);

                    // Xử lý mức độ khó
                    let levelDesc = "";
                    if (difficulty === 'easy') levelDesc = "đơn giản, ngắn gọn, dùng từ vựng cơ bản (A1-A2)";
                    else if (difficulty === 'medium') levelDesc = "tự nhiên, độ dài vừa phải, dùng cấu trúc câu ghép (B1-B2)";
                    else levelDesc = "phức tạp, học thuật, văn phong báo chí hoặc chuyên ngành (C1-C2)";

                    if (scope === 'word') {
                        sys += " Output format: { \"items\": [ { \"word\": \"...\", \"sentence\": \"...\" } ] }";
                        if (mode === 1) { 
                            prompt = `Danh sách từ: ${words.join(', ')}. Với MỖI từ, hãy tạo 1 câu tiếng Việt mang ý nghĩa (${levelDesc}) chứa nghĩa của nó (KHÔNG dùng từ tiếng Anh đó).`;
                        } else { 
                            prompt = `Danh sách từ: ${words.join(', ')}. Với MỖI từ, hãy tạo 1 câu tiếng Anh (${levelDesc}) chứa từ đó.`;
                        }
                    } else {
                        sys += " Output format: { \"content\": \"...\" }";
                        if (mode === 1) {
                            prompt = `Viết đoạn văn tiếng Việt (${levelDesc}) sao cho khi dịch sang Anh bắt buộc phải dùng các từ: ${words.join(', ')}.`;
                        } else {
                            prompt = `Viết đoạn văn tiếng Anh (${levelDesc}) kết nối các từ: ${words.join(', ')}.`;
                        }
                    }

                    const res = await callGemini(prompt, sys);
                    
                    if (scope === 'word') {
                        setChallenges(res.items);
                    } else {
                        setChallenges(res.content);
                    }
                    setStep('challenge');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleCheck = async () => {
                setLoading(true); setError('');
                try {
                    let prompt = "";
                    let sys = "";

                    if (scope === 'word') {
                        sys = `Bạn là giáo viên. Trả về JSON: { "results": [ { "score": number, "correction": "string", "explanation": "string" } ] }. Thứ tự mảng kết quả phải khớp với thứ tự mảng đầu vào.`;
                        
                        const submission = challenges.map((c, idx) => ({
                            original_word: c.word,
                            question_context: c.sentence,
                            user_answer: userAnswers[idx] || ""
                        }));

                        prompt = `Chấm điểm danh sách bài làm sau:\n${JSON.stringify(submission)}\n
                        Yêu cầu: 
                        - Mode: ${mode === 1 ? "Đề Việt -> Đáp án Anh" : "Đề Anh -> Đáp án Việt"}
                        - Nếu Mode 1: Kiểm tra xem user có dùng đúng từ gốc (original_word) không và ngữ pháp đúng không.
                        - Nếu Mode 2: Kiểm tra bản dịch tiếng Việt có tự nhiên không.`;
                        
                    } else {
                        sys = `Bạn là giáo viên. Trả về JSON: { "score": number, "correction": "string", "explanation": "string" }`;
                        prompt = `Đề bài: ${challenges}\nBài làm của user: ${userAnswers['paragraph']}\nMode: ${mode === 1 ? "Viết Anh" : "Dịch Việt"}. Chấm điểm, sửa lỗi và giải thích chi tiết.`;
                    }

                    const res = await callGemini(prompt, sys);
                    setFeedback(res); 
                    if(rightColumnRef.current) rightColumnRef.current.scrollTop = 0;

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-2">
                            <span className="text-indigo-600"><IconBook /></span>
                            <h1 className="text-xl font-bold text-slate-900">PolyGlot Coach <span className="text-xs font-normal text-slate-500 px-2 py-1 bg-slate-100 rounded-full">V3 Split View</span></h1>
                        </div>
                        <button onClick={() => setShowKeyInput(true)} className="text-sm font-medium text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                            <IconKey /> {apiKey ? 'Đổi Key' : 'Nhập Key'}
                        </button>
                    </header>

                    {showKeyInput && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full">
                                <h3 className="text-lg font-bold mb-3">Cấu hình API Key</h3>
                                <input type="text" placeholder="AIza..." className="w-full p-3 border rounded-lg mb-4 bg-slate-50 font-mono text-sm" value={apiKey} onChange={e => setApiKey(e.target.value)} />
                                <button onClick={() => saveApiKey(apiKey)} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Xác nhận</button>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 flex overflow-hidden">
                        <div className="w-full lg:w-1/2 flex flex-col border-r border-slate-200 bg-white h-full overflow-y-auto">
                            <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                                {step === 'input' ? (
                                    <div className="space-y-4 fade-in">
                                        {error && <div className="p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
                                        
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => setScope('word')} className={`py-2 rounded-lg text-sm font-semibold border ${scope==='word' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white border-slate-300'}`}>Từ đơn (Nhiều câu)</button>
                                            <button onClick={() => setScope('paragraph')} className={`py-2 rounded-lg text-sm font-semibold border ${scope==='paragraph' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white border-slate-300'}`}>Đoạn văn (1 bài)</button>
                                        </div>

                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => setMode(1)} className={`py-2 rounded-lg text-sm font-medium border ${mode===1 ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-white border-slate-200'}`}>Luyện Viết (Anh)</button>
                                            <button onClick={() => setMode(2)} className={`py-2 rounded-lg text-sm font-medium border ${mode===2 ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-white border-slate-200'}`}>Luyện Dịch (Việt)</button>
                                        </div>

                                        {/* --- DIFFICULTY SELECTOR (MỚI THÊM) --- */}
                                        <div className="mt-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Độ khó bài tập</label>
                                            <div className="flex gap-2">
                                                {['easy', 'medium', 'hard'].map(level => (
                                                    <button 
                                                        key={level}
                                                        onClick={() => setDifficulty(level)}
                                                        className={`flex-1 py-1.5 rounded-lg text-xs font-bold border capitalize transition-all ${
                                                            difficulty === level 
                                                            ? 'bg-slate-700 text-white border-slate-700 shadow-md' 
                                                            : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'
                                                        }`}
                                                    >
                                                        {level === 'easy' ? 'Dễ (Easy)' : level === 'medium' ? 'Vừa (Medium)' : 'Khó (Hard)'}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <textarea 
                                            value={inputData} onChange={e => setInputData(e.target.value)}
                                            placeholder={scope === 'word' ? "Nhập danh sách từ (xuống dòng hoặc phẩy)...\nVí dụ:\nrun\nfast\nhappy" : "Nhập danh sách từ để viết đoạn văn..."}
                                            className="w-full p-4 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-200 outline-none h-32 resize-none mt-2"
                                        />

                                        <button onClick={handleGenerate} disabled={loading || !inputData} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 flex justify-center items-center gap-2">
                                            {loading ? <IconRefresh /> : <IconArrowRight />} {loading ? 'Đang tạo đề...' : 'Bắt đầu làm bài'}
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <span className="text-xs font-bold text-slate-500 uppercase block">Chế độ</span>
                                            <span className="font-semibold text-slate-800 flex items-center gap-2">
                                                {scope === 'word' ? 'Bài tập từng câu' : 'Bài tập đoạn văn'}
                                                <span className="text-xs px-2 py-0.5 bg-slate-200 rounded text-slate-600 font-normal uppercase">{difficulty}</span>
                                            </span>
                                        </div>
                                        <button onClick={() => {setStep('input'); setFeedback(null);}} className="text-indigo-600 text-sm font-medium hover:underline">Tạo bài mới</button>
                                    </div>
                                )}
                            </div>

                            {step === 'challenge' && (
                                <div className="p-6 flex-1 bg-slate-50 space-y-6">
                                    {scope === 'word' ? (
                                        challenges.map((item, idx) => (
                                            <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 fade-in" style={{animationDelay: `${idx * 0.1}s`}}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Câu {idx + 1} ({item.word})</span>
                                                    {mode === 2 && <button onClick={() => speakText(item.sentence)} className="text-indigo-500 hover:bg-indigo-50 p-1 rounded"><IconSpeaker /></button>}
                                                </div>
                                                <p className="text-lg text-slate-800 font-medium mb-4">{item.sentence}</p>
                                                
                                                <input 
                                                    type="text"
                                                    value={userAnswers[idx] || ''}
                                                    onChange={(e) => setUserAnswers({...userAnswers, [idx]: e.target.value})}
                                                    placeholder={mode === 1 ? "Viết lại câu bằng tiếng Anh..." : "Dịch câu này sang tiếng Việt..."}
                                                    className="w-full p-3 border border-slate-300 rounded-lg focus:border-indigo-500 outline-none"
                                                />
                                            </div>
                                        ))
                                    ) : (
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 fade-in">
                                            <div className="flex justify-between mb-2">
                                                <span className="text-xs font-bold text-slate-400 uppercase">Đề bài</span>
                                                {mode === 2 && <button onClick={() => speakText(challenges)} className="text-indigo-500"><IconSpeaker /></button>}
                                            </div>
                                            <p className="text-lg leading-relaxed text-slate-800 mb-6 pb-6 border-b border-slate-100">{challenges}</p>
                                            
                                            <label className="block text-sm font-bold text-slate-700 mb-2">Bài làm của bạn:</label>
                                            <textarea 
                                                value={userAnswers['paragraph'] || ''}
                                                onChange={(e) => setUserAnswers({...userAnswers, 'paragraph': e.target.value})}
                                                className="w-full h-48 p-4 border border-slate-300 rounded-lg focus:border-indigo-500 outline-none resize-none"
                                                placeholder={mode === 1 ? "Viết đoạn văn tiếng Anh..." : "Dịch đoạn văn sang tiếng Việt..."}
                                            />
                                        </div>
                                    )}

                                    <div className="pt-4 pb-8">
                                        <button onClick={handleCheck} disabled={loading} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 flex justify-center items-center gap-2">
                                            {loading ? 'Đang chấm điểm...' : <><IconCheck /> Nộp bài & Xem kết quả</>}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div ref={rightColumnRef} className="hidden lg:block w-1/2 h-full bg-slate-100 overflow-y-auto border-l border-slate-200">
                            {!feedback ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                                    <div className="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4">
                                        <IconCheck />
                                    </div>
                                    <h3 className="font-semibold text-lg text-slate-600">Khu vực Chấm điểm</h3>
                                    <p className="text-sm max-w-xs mt-2">Kết quả đánh giá, sửa lỗi chi tiết từ AI sẽ hiển thị ở đây sau khi bạn nộp bài.</p>
                                </div>
                            ) : (
                                <div className="p-8 space-y-6 fade-in">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-2xl font-bold text-slate-800">Kết quả chi tiết</h2>
                                        {scope === 'paragraph' && (
                                            <span className={`px-4 py-2 rounded-full font-bold text-white ${feedback.score >= 8 ? 'bg-green-500' : 'bg-orange-500'}`}>
                                                {feedback.score}/10
                                            </span>
                                        )}
                                    </div>

                                    {scope === 'word' ? (
                                        feedback.results.map((res, idx) => (
                                            <div key={idx} className={`p-5 rounded-xl border-2 bg-white ${res.score >= 8 ? 'border-green-100' : 'border-orange-100'}`}>
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="text-sm font-bold text-slate-500">Câu {idx + 1}</span>
                                                    <span className={`text-xs font-bold px-2 py-1 rounded ${res.score >= 8 ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                                        {res.score}/10
                                                    </span>
                                                </div>
                                                
                                                <div className="mb-3">
                                                    <p className="text-xs text-slate-400 uppercase mb-1">Đáp án gợi ý:</p>
                                                    <div className="flex items-start gap-2">
                                                        <p className="font-medium text-slate-800">{res.correction}</p>
                                                        {mode===1 && <button onClick={() => speakText(res.correction)} className="text-indigo-500 mt-1"><IconSpeaker/></button>}
                                                    </div>
                                                </div>
                                                
                                                <div className="pt-3 border-t border-slate-100">
                                                    <p className="text-sm text-slate-600"><span className="font-semibold">Nhận xét:</span> {res.explanation}</p>
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="mb-6">
                                                <h3 className="font-bold text-slate-700 mb-2">Bài sửa hoàn chỉnh:</h3>
                                                <p className="text-lg text-slate-900 leading-relaxed p-4 bg-green-50 rounded-lg border border-green-100">
                                                    {feedback.correction}
                                                </p>
                                                {mode===1 && <button onClick={() => speakText(feedback.correction)} className="mt-2 text-indigo-600 text-sm font-medium flex items-center gap-1"><IconSpeaker/> Nghe bài mẫu</button>}
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-700 mb-2">Chi tiết lỗi sai:</h3>
                                                <p className="text-slate-600 leading-relaxed whitespace-pre-wrap">{feedback.explanation}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>